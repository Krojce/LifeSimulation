#version 400

in vec2 passTextureCoords;
in vec4 passLighting;
in vec3 passSurfaceNormal;
in vec3 passSurfacePosition;

out vec4 outColor;

uniform sampler2D textureSampler;

uniform mat4 viewMatrix;

uniform vec3 pointLightPosition[5];
uniform vec3 pointLightAmbient[5];
uniform vec3 pointLightDiffuse[5];
uniform vec3 pointLightColor[5];
uniform vec3 pointLightAttenuation[5];

const float pointLightPower = 1.0;
const float fogDensity = 0.001;
const vec4 fogColor = vec4(0.0, 0.0, 0.0, 1.0);
const vec4 skyColor = vec4(0.0, 0.0, 0.0, 1.0);

vec3 calculatePointLight() {

    vec3 viewDirection = vec3(viewMatrix[1][3], viewMatrix[2][3], viewMatrix[3][3]);

    vec3 totalDiffuse = vec3(0.0);
    vec3 totalSpecular = vec3(0.0);
    vec3 totalAmbient = vec3(0.0);

    for(int i = 0; i < 5; i++) {
            vec3 lightDir = normalize(-pointLightPosition[i]);

            // attenuation
            float distance = length(pointLightPosition[i] - passSurfacePosition);
            float attFactor = 1.0 / (pointLightAttenuation[i].x + (pointLightAttenuation[i].y * distance) + (pointLightAttenuation[i].z * distance * distance));

            // diffuse shading
            float diffuseFactor = max(dot(passSurfaceNormal, lightDir), 0.0);

            // specular shading
            vec3 reflectDirection = reflect(-lightDir, passSurfaceNormal);
            float specularFactor = pow(max(dot(viewDirection, reflectDirection), 0.0), 0);

            // combine results
            totalDiffuse  += (pointLightColor[i] * diffuseFactor * attFactor);
            totalSpecular += (pointLightColor[i] * specularFactor * attFactor);
    }
    return (totalDiffuse + totalSpecular) * pointLightPower;
}

void main(void){
    float distance = gl_FragCoord.z / gl_FragCoord.w;
    float fogFactor = 1.0 /exp(distance * fogDensity);
    fogFactor = clamp(fogFactor, 0.0, 1.0);
    vec4 colorWithLighting =  texture(textureSampler, passTextureCoords) * max(passLighting, 0.3);
	vec4 finalColor = mix(skyColor, colorWithLighting, fogFactor);
	outColor = finalColor + vec4(calculatePointLight(), 1.0);
	if(fogFactor < 0.0) {
	    outColor = vec4(1 - fogFactor, 0.0, 0.0, 0.0);
	}
}